pipeline {
    agent any
    
    tools {
        // Assume que estas ferramentas est√£o configuradas
        maven 'Maven-3.9'
        jdk 'JDK-17'
    }
    
    // VARI√ÅVEIS DE AMBIENTE
    environment {
        // Nome da imagem no Docker Hub (rickelmedias/subscription-service)
        DOCKER_IMAGE = 'rickelmedias/subscription-service'
        // Tag para a vers√£o espec√≠fica (e.g., 1, 2, 3...)
        DOCKER_TAG = "${BUILD_NUMBER}"
        // ID da credencial de usu√°rio/senha do Docker Hub configurada no Jenkins
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
    }
    
    stages {
        stage('Checkout SCM') {
            steps {
                echo 'üîÑ Clonando reposit√≥rio e verificando a branch...'
                checkout scm
            }
        }
        
        stage('Build JAR') {
            steps {
                echo 'üî® Compilando e empacotando aplica√ß√£o (Pulando testes)...'
                // Usa 'package' para gerar o JAR. '-DskipTests' √© apropriado aqui.
                sh 'mvn clean package -DskipTests'
                archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true
            }
        }
        
        stage('Build & Tag Docker Image') {
            steps {
                echo 'üê≥ Construindo imagem Docker...'
                
                // 1. Constr√≥i a imagem com a tag BUILD_NUMBER
                sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                
                echo "üè∑Ô∏è Marcando como 'latest'..."
                // 2. Cria a tag 'latest'
                sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
            }
        }
        
        stage('Push Docker Image') {
            steps {
                echo 'üì§ Enviando imagem para Docker Hub...'
                // Usa withCredentials para injetar o usu√°rio e senha de forma segura.
                withCredentials([
                    usernamePassword(
                        credentialsId: "${DOCKER_CREDENTIALS_ID}", 
                        usernameVariable: 'DOCKER_USER', 
                        passwordVariable: 'DOCKER_PASS'
                    )
                ]) {
                    // O login √© feito de forma segura (via stdin)
                    sh """
                        echo "\$DOCKER_PASS" | docker login -u "\$DOCKER_USER" --password-stdin
                        
                        echo "Pushing ${DOCKER_IMAGE}:${DOCKER_TAG}..."
                        docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
                        
                        echo "Pushing ${DOCKER_IMAGE}:latest..."
                        docker push ${DOCKER_IMAGE}:latest
                        
                        # Opcional: fazer logout do Docker Hub
                        docker logout
                    """
                }
                echo '‚úÖ Imagem Docker enviada com sucesso!'
            }
        }
    }
    
    // A√á√ïES FINAIS
    post {
        always {
            echo 'üßπ Limpeza e finaliza√ß√£o do Pipeline...'
        }
        success {
            echo '‚úÖ Pipeline IMAGE_DOCKER executado com SUCESSO!'
            echo "üì¶ Imagens criadas: ${DOCKER_IMAGE}:${DOCKER_TAG} e ${DOCKER_IMAGE}:latest"
        }
        failure {
            echo '‚ùå Pipeline IMAGE_DOCKER FALHOU! Verifique as etapas de Build ou Push.'
        }
    }
}
