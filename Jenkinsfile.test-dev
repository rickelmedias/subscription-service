pipeline {
    agent any
    
    tools {
        // Assume que estas ferramentas est√£o configuradas no Jenkins Global Tool Configuration
        maven 'Maven-3.9'
        jdk 'JDK-17'
    }
    
    // VARI√ÅVEIS DE AMBIENTE
    environment {
        // Note: O JaCoCo deve ser configurado no pom.xml para falhar o build
        // se a cobertura for menor que este valor, tornando esta vari√°vel opcional.
        QUALITY_GATE_THRESHOLD = '0.99' 
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üîÑ Clonando reposit√≥rio e verificando a branch...'
                checkout scm
            }
        }
        
        stage('Build & Unit Tests') {
            steps {
                echo 'üî® Compilando, empacotando e executando testes unit√°rios...'
                // Usa 'install' para garantir que os testes rodem (incluindo JaCoCo instrumentation)
                // e que o JAR seja empacotado para o arquivo (se necess√°rio).
                sh 'mvn clean install' 
            }
            // Bloco 'post' dentro do stage para processamento imediato
            post {
                always {
                    // Publica o relat√≥rio JUnit (Surefire)
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Code Analysis (PMD)') {
            steps {
                echo 'üîç Executando An√°lise Est√°tica de C√≥digo (PMD)...'
                // O pmd:pmd gera o relat√≥rio XML
                sh 'mvn pmd:pmd'
            }
            post {
                always {
                    // Publica o relat√≥rio PMD
                    recordIssues(
                        enabledForFailure: true,
                        tools: [pmdParser(pattern: '**/target/pmd.xml')]
                    )
                }
            }
        }
        
        stage('Coverage & Quality Gate') {
            steps {
                echo "üìä Gerando relat√≥rio JaCoCo e aplicando Quality Gate (Cobertura: ${env.QUALITY_GATE_THRESHOLD})..."
                
                // 1. Gera o relat√≥rio JaCoCo (jacoco:report)
                // 2. Aplica o JaCoCo Check (jacoco:check)
                //    Se a cobertura for menor que o limite configurado no pom.xml, o build ir√° FALHAR aqui (exit code != 0)
                sh 'mvn jacoco:report jacoco:check'
                echo "‚úÖ JaCoCo Check PASSOU!"
            }
            post {
                // Publica o relat√≥rio JaCoCo
                always {
                    jacoco(
                        execPattern: '**/target/jacoco.exec',
                        classPattern: '**/target/classes',
                        sourcePattern: '**/src/main/java',
                        // Mant√©m a exclus√£o para classes que n√£o devem ser testadas
                        exclusionPattern: '**/dto/**,**/config/**,**/SubscriptionApplication.class' 
                    )
                }
            }
        }
    }
    
    // A√á√ïES FINAIS
    post {
        // A√ß√µes de arquivamento para todos os casos
        always {
            echo 'üì¶ Arquivando relat√≥rios e artefatos...'
            // Arquivamento consolidado para logs e relat√≥rios
            archiveArtifacts artifacts: '**/target/surefire-reports/*, **/target/pmd.xml, **/target/site/jacoco/**', fingerprint: true
            
            echo 'üìã Relat√≥rios de Qualidade dispon√≠veis no Jenkins.'
        }
        // A√ß√µes condicionais
        success {
            echo '‚úÖ Pipeline TEST-DEV executado com SUCESSO! Todos os gates de qualidade PASSARAM.'
        }
        unstable {
            // Unstable ocorre se o Quality Gate for configurado para retornar UNSTABLE em vez de FAILURE
            echo '‚ö†Ô∏è Pipeline UNSTABLE! Quality Gate n√£o atingido.'
        }
        failure {
            echo '‚ùå Pipeline TEST-DEV FALHOU! Revise os testes unit√°rios ou o c√≥digo.'
        }
    }
}
