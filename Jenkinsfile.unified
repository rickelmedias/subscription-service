/**
 * =============================================================================
 * JENKINSFILE UNIFICADO - DEV + IMAGE_DOCKER + STAGING
 * =============================================================================
 * 
 * Este pipeline integra trÃªs estÃ¡gios principais do ciclo DevOps:
 *   1. DEV         - Testes unitÃ¡rios, anÃ¡lise de cÃ³digo (PMD) e quality gate (JaCoCo)
 *   2. IMAGE_DOCKER - Build e push da imagem Docker para o Docker Hub
 *   3. STAGING     - Deploy e validaÃ§Ã£o no ambiente de staging
 *
 * Autor: Pipeline Groovy unificado sem uso de Freestyle
 * =============================================================================
 */

pipeline {
    agent any
    
    // =========================================================================
    // CONFIGURAÃ‡ÃƒO DE FERRAMENTAS
    // =========================================================================
    tools {
        maven 'Maven-3.9'
        jdk 'JDK-17'
    }
    
    // =========================================================================
    // VARIÃVEIS DE AMBIENTE GLOBAIS
    // =========================================================================
    environment {
        // ConfiguraÃ§Ãµes de qualidade
        QUALITY_GATE_THRESHOLD = '0.99'
        
        // ConfiguraÃ§Ãµes Docker
        DOCKER_IMAGE = 'rickelmedias/subscription-service'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials'
        
        // ConfiguraÃ§Ãµes de ambiente
        STAGING_PORT = '8686'
        STAGING_COMPOSE_FILE = 'docker-compose.staging.yml'
    }
    
    // =========================================================================
    // OPÃ‡Ã•ES DO PIPELINE
    // =========================================================================
    options {
        // Timeout global do pipeline (30 minutos)
        timeout(time: 30, unit: 'MINUTES')
        // MantÃ©m apenas os Ãºltimos 10 builds
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // Desabilita checkout automÃ¡tico (faremos manualmente)
        skipDefaultCheckout(true)
        // Adiciona timestamps nos logs
        timestamps()
    }
    
    stages {
        // =====================================================================
        // FASE 1: DEV - TESTES E QUALIDADE DE CÃ“DIGO
        // =====================================================================
        
        stage('ğŸ“¥ Checkout SCM') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ”„ FASE 1: DEV - Iniciando checkout do repositÃ³rio...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                checkout scm
                
                script {
                    // Exibe informaÃ§Ãµes do commit para rastreabilidade
                    def gitCommit = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    def gitBranch = sh(script: 'git rev-parse --abbrev-ref HEAD', returnStdout: true).trim()
                    echo "ğŸ“Œ Branch: ${gitBranch}"
                    echo "ğŸ“Œ Commit: ${gitCommit}"
                    
                    // Armazena para uso posterior
                    env.GIT_COMMIT_SHORT = gitCommit
                    env.GIT_BRANCH_NAME = gitBranch
                }
            }
        }
        
        stage('ğŸ”¨ Build & Unit Tests') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ”¨ Compilando aplicaÃ§Ã£o e executando testes unitÃ¡rios...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                // Executa build completo com testes
                sh 'mvn clean install'
                
                echo 'âœ… Build e testes unitÃ¡rios concluÃ­dos!'
            }
            post {
                always {
                    // Publica relatÃ³rio JUnit (Surefire)
                    junit(
                        testResults: '**/target/surefire-reports/*.xml',
                        allowEmptyResults: true
                    )
                }
                failure {
                    echo 'âŒ Falha nos testes unitÃ¡rios!'
                }
            }
        }
        
        stage('ğŸ” Code Analysis (PMD)') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ” Executando anÃ¡lise estÃ¡tica de cÃ³digo com PMD...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                // Executa anÃ¡lise PMD
                sh 'mvn pmd:pmd pmd:check'
                
                echo 'âœ… AnÃ¡lise PMD concluÃ­da sem violaÃ§Ãµes crÃ­ticas!'
            }
            post {
                always {
                    // Publica relatÃ³rio PMD
                    recordIssues(
                        enabledForFailure: true,
                        aggregatingResults: true,
                        tools: [pmdParser(pattern: '**/target/pmd.xml')]
                    )
                }
            }
        }
        
        stage('ğŸ“Š Coverage & Quality Gate') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo "ğŸ“Š Verificando cobertura de cÃ³digo (MÃ­nimo: ${env.QUALITY_GATE_THRESHOLD})..."
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                // Gera relatÃ³rio e verifica cobertura mÃ­nima
                sh 'mvn jacoco:report jacoco:check'
                
                echo 'âœ… Quality Gate APROVADO! Cobertura mÃ­nima atingida.'
            }
            post {
                always {
                    // Publica relatÃ³rio JaCoCo
                    jacoco(
                        execPattern: '**/target/jacoco.exec',
                        classPattern: '**/target/classes',
                        sourcePattern: '**/src/main/java',
                        inclusionPattern: '**/*.class',
                        exclusionPattern: '**/dto/**,**/config/**,**/SubscriptionApplication.class'
                    )
                }
            }
        }
        
        // =====================================================================
        // FASE 2: IMAGE_DOCKER - BUILD E PUSH DA IMAGEM
        // =====================================================================
        
        stage('ğŸ“¦ Package Artifact') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ”„ FASE 2: IMAGE_DOCKER - Empacotando aplicaÃ§Ã£o...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                // Gera JAR final (testes jÃ¡ foram executados)
                sh 'mvn package -DskipTests'
                
                echo 'âœ… Artefato JAR criado com sucesso!'
            }
        }
        
        stage('ğŸ³ Build Docker Image') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ³ Construindo imagem Docker...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                script {
                    // ConstrÃ³i imagem com tag do BUILD_NUMBER
                    sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                    
                    // Adiciona tag 'latest'
                    sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
                    
                    // Adiciona tag com commit (para rastreabilidade)
                    sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:${env.GIT_COMMIT_SHORT}"
                    
                    echo "âœ… Imagens criadas:"
                    echo "   - ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    echo "   - ${DOCKER_IMAGE}:latest"
                    echo "   - ${DOCKER_IMAGE}:${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        
        stage('ğŸ“¤ Push Docker Image') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ“¤ Enviando imagem para Docker Hub...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                script {
                    // Autentica e envia imagens para o Docker Hub
                    withCredentials([
                        usernamePassword(
                            credentialsId: "${DOCKER_CREDENTIALS_ID}",
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_PASS'
                        )
                    ]) {
                        sh '''
                            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                            
                            echo "ğŸ“¤ Pushing ${DOCKER_IMAGE}:${DOCKER_TAG}..."
                            docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
                            
                            echo "ğŸ“¤ Pushing ${DOCKER_IMAGE}:latest..."
                            docker push ${DOCKER_IMAGE}:latest
                            
                            echo "ğŸ“¤ Pushing ${DOCKER_IMAGE}:${GIT_COMMIT_SHORT}..."
                            docker push ${DOCKER_IMAGE}:${GIT_COMMIT_SHORT}
                            
                            docker logout
                        '''
                    }
                    
                    echo 'âœ… Imagens enviadas com sucesso para o Docker Hub!'
                }
            }
        }
        
        // =====================================================================
        // FASE 3: STAGING - DEPLOY E VALIDAÃ‡ÃƒO
        // =====================================================================
        
        stage('ğŸš€ Deploy Staging') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ”„ FASE 3: STAGING - Iniciando deploy no ambiente staging...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                script {
                    // Para containers existentes (se houver)
                    sh "docker compose -f ${STAGING_COMPOSE_FILE} down --remove-orphans || true"
                    
                    // Baixa a imagem mais recente
                    sh "docker compose -f ${STAGING_COMPOSE_FILE} pull"
                    
                    // Inicia os containers em modo detached
                    sh "docker compose -f ${STAGING_COMPOSE_FILE} up -d --no-color"
                    
                    echo 'â³ Aguardando serviÃ§o se tornar saudÃ¡vel...'
                    
                    // Aguarda o serviÃ§o ficar disponÃ­vel (mÃ¡ximo 5 minutos)
                    timeout(time: 5, unit: 'MINUTES') {
                        waitUntil(initialRecurrencePeriod: 10000, quiet: true) {
                            def status = sh(
                                script: "curl -sf http://localhost:${STAGING_PORT}/actuator/health || exit 1",
                                returnStatus: true
                            )
                            return status == 0
                        }
                    }
                    
                    echo "âœ… ServiÃ§o de Staging UP e respondendo na porta ${STAGING_PORT}!"
                }
            }
        }
        
        stage('ğŸ§ª Staging Tests') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ§ª Executando testes de validaÃ§Ã£o no ambiente staging...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                script {
                    // Teste 1: Health Check
                    echo 'ğŸ“‹ Teste 1: Verificando Health Check...'
                    def healthResponse = sh(
                        script: "curl -sf http://localhost:${STAGING_PORT}/actuator/health",
                        returnStdout: true
                    ).trim()
                    echo "   Response: ${healthResponse}"
                    
                    // Teste 2: Info endpoint (se disponÃ­vel)
                    echo 'ğŸ“‹ Teste 2: Verificando Info endpoint...'
                    sh(
                        script: "curl -sf http://localhost:${STAGING_PORT}/actuator/info || echo 'Info endpoint nÃ£o disponÃ­vel'",
                        returnStatus: true
                    )
                    
                    // Teste 3: Swagger/OpenAPI (se disponÃ­vel)
                    echo 'ğŸ“‹ Teste 3: Verificando documentaÃ§Ã£o API...'
                    sh(
                        script: "curl -sf http://localhost:${STAGING_PORT}/swagger-ui.html || curl -sf http://localhost:${STAGING_PORT}/v3/api-docs || echo 'DocumentaÃ§Ã£o API nÃ£o disponÃ­vel'",
                        returnStatus: true
                    )
                    
                    echo 'âœ… Testes de staging concluÃ­dos com sucesso!'
                }
            }
        }
        
        stage('ğŸ“‹ Verification Logs') {
            steps {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'ğŸ“‹ Coletando logs e status dos containers...'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                
                // Status dos containers
                sh "docker compose -f ${STAGING_COMPOSE_FILE} ps"
                
                // Logs dos containers (Ãºltimas 50 linhas)
                sh "docker compose -f ${STAGING_COMPOSE_FILE} logs --tail 50"
            }
        }
    }
    
    // =========================================================================
    // AÃ‡Ã•ES FINAIS (POST-BUILD)
    // =========================================================================
    post {
        always {
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'ğŸ“¦ Arquivando artefatos e finalizando pipeline...'
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            
            // Arquiva artefatos importantes
            archiveArtifacts(
                artifacts: '''
                    **/target/*.jar,
                    **/target/surefire-reports/*,
                    **/target/pmd.xml,
                    **/target/site/jacoco/**
                ''',
                fingerprint: true,
                allowEmptyArchive: true
            )
            
            // Limpeza de imagens Docker locais (opcional)
            script {
                sh '''
                    echo "ğŸ§¹ Limpeza de recursos Docker..."
                    docker image prune -f || true
                '''
            }
        }
        
        success {
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âœ… PIPELINE COMPLETO COM SUCESSO!'
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo "ğŸ“Œ Branch: ${env.GIT_BRANCH_NAME}"
            echo "ğŸ“Œ Commit: ${env.GIT_COMMIT_SHORT}"
            echo "ğŸ“Œ Imagem Docker: ${DOCKER_IMAGE}:${DOCKER_TAG}"
            echo "ğŸ“Œ Ambiente Staging: http://localhost:${STAGING_PORT}"
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            
            // NotificaÃ§Ã£o de sucesso (exemplo com Slack - descomente se usar)
            // slackSend(
            //     color: 'good',
            //     message: "âœ… Pipeline SUCESSO: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            // )
        }
        
        failure {
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âŒ PIPELINE FALHOU!'
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'Verifique os logs acima para identificar o problema.'
            
            // Em caso de falha, derruba o ambiente staging
            script {
                sh "docker compose -f ${STAGING_COMPOSE_FILE} down --remove-orphans || true"
            }
            
            // NotificaÃ§Ã£o de falha (exemplo com Slack - descomente se usar)
            // slackSend(
            //     color: 'danger',
            //     message: "âŒ Pipeline FALHOU: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            // )
        }
        
        unstable {
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âš ï¸ PIPELINE INSTÃVEL!'
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'Alguns testes ou verificaÃ§Ãµes nÃ£o passaram completamente.'
        }
        
        aborted {
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'ğŸ›‘ PIPELINE ABORTADO!'
            echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            
            // Limpa ambiente em caso de abort
            script {
                sh "docker compose -f ${STAGING_COMPOSE_FILE} down --remove-orphans || true"
            }
        }
    }
}


