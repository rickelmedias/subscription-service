pipeline {
    agent any
    
    stages {
        stage('Checkout SCM') {
            steps {
                echo 'üîÑ Clonando reposit√≥rio e verificando a branch...'
                checkout scm
            }
        }
        
        stage('Start Production Container') {
            steps {
                echo 'üöÄ Iniciando container de Produ√ß√£o (docker-compose.prod.yml)...'
                
                // CORRE√á√ÉO: Usando o comando moderno 'docker compose'
                sh 'docker compose -f docker-compose.prod.yml pull' 
                
                // Sobe os containers em modo detached (-d)
                sh 'docker compose -f docker-compose.prod.yml up -d --no-color'
                
                echo '‚è≥ Aguardando o servi√ßo Spring Boot se tornar saud√°vel...'
                
                // L√≥gica de resili√™ncia: espera at√© 5 minutos (300 segundos) para o servi√ßo responder
                script {
                    timeout(time: 5, unit: 'MINUTES') { 
                        waitUntil {
                            // O curl -f retorna status 0 apenas se a conex√£o for bem-sucedida E o HTTP for 2xx.
                            sh(script: 'curl -f http://localhost:8585/actuator/health', returnStatus: true) == 0
                        }
                    }
                    echo "‚úÖ Servi√ßo de Produ√ß√£o UP e respondendo na porta 8585!"
                }
            }
        }
        
        stage('Run Sanity Tests') {
            steps {
                echo 'üß™ Executando testes b√°sicos de sanidade no container...'
                
                // O teste j√° foi feito na etapa anterior, mas voc√™ pode adicionar mais aqui.
                script {
                    def response = sh(
                        script: 'curl -f http://localhost:8585/algum/endpoint/de/teste || echo "Falha no teste de sanidade"',
                        returnStatus: true
                    )
                    if (response != 0) {
                        error "‚ùå Teste de Sanidade FALHOU! O endpoint essencial n√£o respondeu."
                    } else {
                        echo "‚úÖ Teste de Sanidade APROVADO."
                    }
                }
            }
        }
        
        stage('Verification Logs') {
            steps {
                // Logs para verifica√ß√£o e depura√ß√£o
                sh 'docker compose -f docker-compose.prod.yml ps'
                sh 'docker compose -f docker-compose.prod.yml logs --tail 20' // Exibe as √∫ltimas 20 linhas de logs
            }
        }
    }
    
    // A√á√ïES FINAIS
    post {
        always {
            echo 'üìã Pipeline finalizado.'
            // Removendo os comandos de logs/status daqui pois j√° est√£o na √∫ltima stage.
        }
        success {
            echo 'üöÄ Implanta√ß√£o de Produ√ß√£o executada com SUCESSO!'
        }
        failure {
            echo '‚ùå Implanta√ß√£o de Produ√ß√£o FALHOU! Verifique o log.'
            // Adicionar a√ß√£o para reverter ou notificar aqui.
        }
    }
}
